<!DOCTYPE html>
<html>
<head>
	<title>Rendering</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="UTF-8">


	<style type="text/css">

		@font-face{
			src:url('/resources/GROBOLD.ttf');
			font-family: grobold;
		}

		html,body{
			width: 100%;
			height: 100%;
			font-family: grobold;
		}
		#image,#additional-data,svg{
			width:1000px;
			height: 1000px;
			color: white;
			//visibility: hidden;
		}

		svg{
			position: absolute;
			left: 0;
			top: 0;
		}

		#bg{
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: white;
			display: none;
		}
	</style>

	<script type="text/javascript" src="https://github.com/niklasvh/html2canvas/releases/download/0.4.1/html2canvas.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>


<body>

<div id="image"></div>
<canvas id="canvas"></canvas>
<div id="bg"></div>
<!--<div id="additional-data">
	<p>HAHAHAHAH</p>
</div>-->
<p id="ID">{{.ID}}</p>
<p id="msgType">{{.MsgType}}</p>
<p id="day">{{.Day}}</p>
<p id="month">{{.Month}}</p>
<p id="year">{{.Year}}</p>
<p id="period">{{.Period}}</p>


</body>

<script id="mainscript" type="text/javascript">
	var Canvas2Image = function () {

	var $support = function () {
		var canvas = document.createElement('canvas'),
			ctx = canvas.getContext('2d');

		return {
			canvas: !!ctx,
			imageData: !!ctx.getImageData,
			dataURL: !!canvas.toDataURL,
			btoa: !!window.btoa
		};
	}();

	var downloadMime = 'image/octet-stream';

	function scaleCanvas (canvas, width, height) {
		var w = canvas.width,
			h = canvas.height;
		if (width == undefined) {
			width = w;
		}
		if (height == undefined) {
			height = h;
		}

		var retCanvas = document.createElement('canvas');
		var retCtx = retCanvas.getContext('2d');
		retCanvas.width = width;
		retCanvas.height = height;
		retCtx.drawImage(canvas, 0, 0, w, h, 0, 0, width, height);
		return retCanvas;
	}

	function getDataURL (canvas, type, width, height) {
		canvas = scaleCanvas(canvas, width, height);
		return canvas.toDataURL(type);
	}

	function saveFile (strData) {
		document.location.href = strData;
	}

	function genImage(strData) {
		var img = document.createElement('img');
		img.src = strData;
		return img;
	}
	function fixType (type) {
		type = type.toLowerCase().replace(/jpg/i, 'jpeg');
		var r = type.match(/png|jpeg|bmp|gif/)[0];
		return 'image/' + r;
	}
	function encodeData (data) {
		if (!window.btoa) { throw 'btoa undefined' }
		var str = '';
		if (typeof data == 'string') {
			str = data;
		} else {
			for (var i = 0; i < data.length; i ++) {
				str += String.fromCharCode(data[i]);
			}
		}

		return btoa(str);
	}
	function getImageData (canvas) {
		var w = canvas.width,
			h = canvas.height;
		return canvas.getContext('2d').getImageData(0, 0, w, h);
	}
	function makeURI (strData, type) {
		return 'data:' + type + ';base64,' + strData;
	}

	var genBitmapImage = function (oData) {

		var biWidth  = oData.width;
		var biHeight	= oData.height;
		var biSizeImage = biWidth * biHeight * 3;
		var bfSize  = biSizeImage + 54;

		var BITMAPFILEHEADER = [
			0x42, 0x4D,
			bfSize & 0xff, bfSize >> 8 & 0xff, bfSize >> 16 & 0xff, bfSize >> 24 & 0xff,
			0, 0,
			0, 0,
			54, 0, 0, 0
		];

		var BITMAPINFOHEADER = [
			
			40, 0, 0, 0,
			biWidth & 0xff, biWidth >> 8 & 0xff, biWidth >> 16 & 0xff, biWidth >> 24 & 0xff,
			biHeight & 0xff, biHeight >> 8  & 0xff, biHeight >> 16 & 0xff, biHeight >> 24 & 0xff,
			1, 0,
			24, 0,
			0, 0, 0, 0,
			biSizeImage & 0xff, biSizeImage >> 8 & 0xff, biSizeImage >> 16 & 0xff, biSizeImage >> 24 & 0xff,
			0,0,0,0,
			0,0,0,0,
			0,0,0,0,
			0,0,0,0
		];

		var iPadding = (4 - ((biWidth * 3) % 4)) % 4;

		var aImgData = oData.data;

		var strPixelData = '';
		var biWidth4 = biWidth<<2;
		var y = biHeight;
		var fromCharCode = String.fromCharCode;

		do {
			var iOffsetY = biWidth4*(y-1);
			var strPixelRow = '';
			for (var x = 0; x < biWidth; x++) {
				var iOffsetX = x<<2;
				strPixelRow += fromCharCode(aImgData[iOffsetY+iOffsetX+2]) +
							   fromCharCode(aImgData[iOffsetY+iOffsetX+1]) +
							   fromCharCode(aImgData[iOffsetY+iOffsetX]);
			}

			for (var c = 0; c < iPadding; c++) {
				strPixelRow += String.fromCharCode(0);
			}

			strPixelData += strPixelRow;
		} while (--y);

		var strEncoded = encodeData(BITMAPFILEHEADER.concat(BITMAPINFOHEADER)) + encodeData(strPixelData);

		return strEncoded;
	};

	var saveAsImage = function (canvas, width, height, type) {
		if ($support.canvas && $support.dataURL) {
			if (typeof canvas == "string") { canvas = document.getElementById(canvas); }
			if (type == undefined) { type = 'png'; }
			type = fixType(type);
			if (/bmp/.test(type)) {
				var data = getImageData(scaleCanvas(canvas, width, height));
				var strData = genBitmapImage(data);
				saveFile(makeURI(strData, downloadMime));
			} else {
				var strData = getDataURL(canvas, type, width, height);
				saveFile(strData.replace(type, downloadMime));
			}
		}
	};

	var convertToImage = function (canvas, width, height, type) {
		if ($support.canvas && $support.dataURL) {
			if (typeof canvas == "string") { canvas = document.getElementById(canvas); }
			if (type == undefined) { type = 'png'; }
			type = fixType(type);

			if (/bmp/.test(type)) {
				var data = getImageData(scaleCanvas(canvas, width, height));
				var strData = genBitmapImage(data);
				return genImage(makeURI(strData, 'image/bmp'));
			} else {
				var strData = getDataURL(canvas, type, width, height);
				return genImage(strData);
			}
		}
	};



	return {
		saveAsImage: saveAsImage,
		saveAsPNG: function (canvas, width, height) {
			return saveAsImage(canvas, width, height, 'png');
		},
		saveAsJPEG: function (canvas, width, height) {
			return saveAsImage(canvas, width, height, 'jpeg');
		},
		saveAsGIF: function (canvas, width, height) {
			return saveAsImage(canvas, width, height, 'gif');
		},
		saveAsBMP: function (canvas, width, height) {
			return saveAsImage(canvas, width, height, 'bmp');
		},

		convertToImage: convertToImage,
		convertToPNG: function (canvas, width, height) {
			return convertToImage(canvas, width, height, 'png');
		},
		convertToJPEG: function (canvas, width, height) {
			return convertToImage(canvas, width, height, 'jpeg');
		},
		convertToGIF: function (canvas, width, height) {
			return convertToImage(canvas, width, height, 'gif');
		},
		convertToBMP: function (canvas, width, height) {
			return convertToImage(canvas, width, height, 'bmp');
		},
		scaleCanvas:scaleCanvas
	};

}();
</script>


<script type="text/javascript">



$(document).ready(function(){

 	var config = {
	    apiKey: "AIzaSyDb2nPveYGPXyw-SheNorRxM_93HhN5bhg",
	    authDomain: "wallte-2df83.firebaseapp.com",
	    databaseURL: "https://wallte-2df83.firebaseio.com",
	    projectId: "wallte-2df83",
	    storageBucket: "gs://wallte-2df83.appspot.com",
	    messagingSenderId: "629996778487"
 	};

  	var ID=$("#ID").text();
  	var expense=100;
    var income=1000;

	function urltoFile(url, filename, mimeType){
	    return (fetch(url)
	        .then(function(res){return res.arrayBuffer();})
	        .then(function(buf){return new File([buf], filename, {type:mimeType});})
	    );
	}

	function getPreviewImage(canvas,largeUrl){
		var preview=Canvas2Image.scaleCanvas(canvas,240,240)
		
		var image=Canvas2Image.convertToJPEG(preview); 
        document.body.appendChild(image);
		
		var storageRef = firebase.storage().ref().child(ID+"/img"+"-preview");
        imgText=$("img").attr('src')
            
            urltoFile(imgText, "chart"+"-preview"+".jpeg", 'image/jpeg')
				.then(function(file){
	    			storageRef.put(file).then(function(snapshot) {
	    				$("img").remove()

						$.ajax({
							url:"https://wallte.herokuapp.com/replyImage",
							type:"POST",
							data:{
								'ID':ID,
								'msgType':$("#msgType").text(),
								'imageURL': largeUrl,
								'previewURL':snapshot.downloadURL
							},
							success:function(){
								$("body").append("<p id='success-mark'>Success</p>")
							}
						});
						
			});
		})

		
	}


	function getUrlVars()
	{
	    var vars = [], hash;
	    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
	    for(var i = 0; i < hashes.length; i++)
	    {
	        hash = hashes[i].split('=');
	        vars.push(hash[0]);
	        vars[hash[0]] = hash[1];
	    }
	    return vars;
	}

	
/*firebase.database().ref("/user/haha").set({
	json:"hahahah",
});*/
	
	var allTextPopulated=[];
	var textWithPercent=[];
	var tooltipText=[];

	function replicateText(ctx,coll){
		//var elem=$(selector);

		for(var i=0;i<coll.length;i++){
			var data=coll[i];
		//ctx.clearRect(pos.x,pos.y,elem.getBBox().width,elem.getBBox().height);
			ctx.font=data.size+"px grobold";
			ctx.fillStyle=data.fill;
			ctx.fillText(data.text,data.x,data.y);
		}
	}


	function drawStar(canvas,ctx){
		
		var radius=0.7;
		for(var i=0;i<150;i++){
			var x=Math.random()*(canvas.width-radius)+radius/2;
			var y=Math.random()*(canvas.height-radius)+radius/2;
			ctx.fillStyle="#ff0";
			ctx.beginPath();
			ctx.arc(x,y,radius,0,2*Math.PI,true);
			ctx.fill();
		}
	}

	function replicateBox(ctx){

		ctx.save();
		$("path").each(function(){

			if($(this).attr('filter')==undefined){
				return;
			}
			var size=$(this)[0].getBBox();
			ctx.fillStyle="#FF0";
			ctx.globalAlpha = 0.7;
			ctx.fillRect(size.x,size.y,size.width,size.height);
			ctx.fill();
		});
		ctx.restore();

	}

	function getSVGTextData(elem,coll,fill){
		var data={x:elem.attr('x'),y:elem.attr('y'),'text':elem.text(),"size":elem.attr('font-size'),"fill":fill};
		coll.push(data);
		//elem.remove();
	}

	function populateTextSVG(){
		
		$("g text").each(function(){

			if($(this).text().indexOf("%")>=0&&$(this).text().indexOf("(")<0){
				var percentColor='#00ABFF';

		        if(expense==0||income==0){
		        	percentColor='#FFF';
		        }
				getSVGTextData($(this),textWithPercent,percentColor);	
				return;
			}
			getSVGTextData($(this),allTextPopulated,'#FFF');	
		});
		//getSVGTextData("g[column-id='Income'] text");
	}

	function populateTextInDialog(){
		$("g text").each(function(){

			if($(this).text().indexOf("%")>=0&&$(this).text().indexOf("(")>=0){
				if($(this).parent().parent().find('text').length==0){
					return;
				}


				for(var i=0;i<$(this).parent().parent().find('text').length;i++){
					getSVGTextData($($(this).parent().parent().find('text')[i]),tooltipText,"#644033");
				}

			}
		});
	}

	function canvToImage(canvas){

		var imgURI = canvas
						        .toDataURL('image/png')
						        .replace('image/png', 'image/octet-stream');

						    var image=Canvas2Image.convertToJPEG(canvas); 
						  	document.body.appendChild(image);

						  	firebase.initializeApp(config);
						  	var storageRef = firebase.storage().ref().child(ID+"/img");
						        imgText=$("img").attr('src')
						            
						        urltoFile(imgText, 'chart.jpeg', 'image/jpeg')
										.then(function(file){
							    			storageRef.put(file).then(function(snapshot) {
							    				  $("img").remove()
												  getPreviewImage(canvas,snapshot.downloadURL);
											});
								})

	}

	function getDivAsImage(chart){

			var imgGimmick=new Image();
			var subImage=new Image();
			//imgGimmick.setAttribute('crossOrigin', 'anonymous');

			
			var picture=[
				{
					'main':"/resources/happy.png",
					"sub":"/resources/happy_sub.png"
				},
				{
					'main':"/resources/soso.png",
					"sub":"/resources/soso_sub.png"
				},
				{
					'main':"/resources/bad.png",
					"sub":"/resources/bad_sub.png"
				},
				{
					'main':"/resources/awful.png",
					"sub":"/resources/awful_sub.png"
				},
				{
					'main':"/resources/notfound.png",
					"sub":"/resources/notfound.png"
				}
			];
			var percentIncome=income/(income+expense)*100;
			var imgIdx=0;

			if(income==0&&expense==0){
				imgIdx=4;
			}else if(percentIncome<35){
				imgIdx=3;
			}else if(percentIncome<50){
				imgIdx=2;
			}else if(percentIncome<65){
				imgIdx=1;
			}

			subImage.addEventListener('load',function(){
					imgGimmick.addEventListener('load',function(){


								populateTextSVG();
								populateTextInDialog();

							    var svg = document.querySelector('svg');
								var canvas = document.getElementById('canvas');

								canvas.width=$("#image").width()
								canvas.height=$("#image").height()
							    var ctx = canvas.getContext('2d');
						  		var data = (new XMLSerializer()).serializeToString(svg);
								var img = new Image();

								img.addEventListener('load', function () {

									var emojiWidth=imgGimmick.width*4/5;
								    var emojiHeight=imgGimmick.height*4/5;
								    var subEmojiWidth=subImage.width*2/3;
								    var subEmojiHeight=subImage.height*2/3;

								    ctx.drawImage(img, 0, 0);
									drawStar(canvas,ctx);						    

								    if(income==0&&expense==0){
								    	ctx.font="35px grobold";
										ctx.fillStyle="#fff";
										ctx.beginPath();
								    	ctx.fillText("NO DATA",canvas.width/2-130,canvas.height/2);
								    	ctx.fillText("FOUND",canvas.width/2-130,canvas.height/2+45);

								    	ctx.save();
								    	ctx.strokeStyle="#FFF";
								    	ctx.lineWidth=10;
								    	ctx.translate(canvas.width/2-55,canvas.height/2+12.5);
								    	ctx.arc(0,0,150,0,2*Math.PI,true);
								    	ctx.stroke();
								    	ctx.restore();

								    	ctx.drawImage(imgGimmick, canvas.width-emojiWidth-20, canvas.height-emojiHeight,emojiWidth,emojiHeight);
								    }else{
								    	ctx.drawImage(imgGimmick, canvas.width-emojiWidth-20, canvas.height/2-emojiHeight/2-125,emojiWidth,emojiHeight);
								    	ctx.drawImage(subImage, 20, canvas.height-subEmojiHeight+10,subEmojiWidth,subEmojiHeight);
								    }

								    //ctx.font = "22px grobold";
								    //ctx.fillStyle="#644033";
									//ctx.fillText("Jul 2013 Monthly Financial Report",20,50);
									replicateText(ctx,textWithPercent);
									//replicateBox(ctx);
									replicateText(ctx,allTextPopulated);
									replicateText(ctx,tooltipText);

									canvToImage(canvas);
								    

								});


								img.src = chart;
					});

					imgGimmick.src=picture[imgIdx].main;
			});


			subImage.src=picture[imgIdx].sub;




    }






	google.charts.load("current", {packages:["corechart"]});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {

        var data = google.visualization.arrayToDataTable([
          ['Type', 'Number'],
          ['Expense',   expense],
          ['Income',    income],
        ]);

        var percentColor='#00ABFF';
        var titleTextColor="#FFF";

        if(expense==0||income==0){
        	percentColor='#FFF';
        }

        if(expense==0&&income==0){
        	titleTextColor='#FFF';
        }

        var options = {
          title: 'Jul 2013 Monthly Financial Report',
          pieHole: 0.4,
          colors:['#644033','#2c3e50'],
          backgroundColor:{fill:"#321F3F"},
          chartArea:{width:'80%',height:'80%'},
          fontSize:22,
          fontName:'grobold',
          pieSliceTextStyle:{color:"none"},
          tooltip:{trigger:'selection',textStyle:{color:"none",fontSize:19}},
          titleTextStyle:{color:"none",fontSize:23},
          legend:{position:"right",alignment:"end",textStyle:{color:"none"}}
        };

        var chart = new google.visualization.PieChart(document.getElementById('image'));
        google.visualization.events.addListener(chart, 'ready', function(e) {
	    	chart.setSelection([{row:1,column:null},{row:0,column:null}]);
	    	getDivAsImage(chart.getImageURI());
	    });
		chart.draw(data, options);
    }

   /* html2canvas($("#additional-data"), {
        onrendered: function(canvas) {
            theCanvas = canvas;
            var image=Canvas2Image.convertToPNG(canvas); 
            document.body.appendChild(image);
            var storageRef = firebase.storage().ref().child("1/img");
            imgText=$("img").attr('src')
            
            urltoFile(imgText, 'hello.png', 'image/png')
				.then(function(file){
	    			
				})
                
        }
    });*/

});
</script>


</html>