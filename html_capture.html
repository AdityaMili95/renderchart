<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">
		#image{
			width:600px;
			height: 600px;
			background: red;
			visibility: hidden;
		}

		#bg{
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: white;
		}
	</style>
</head>
<script type="text/javascript" src="https://github.com/niklasvh/html2canvas/releases/download/0.4.1/html2canvas.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
<script type="text/javascript" src=""></script>
<body>

<div id="image"></div>

<div id="bg"></div>

</body>


<script id="mainscript" type="text/javascript">
	var Canvas2Image = function () {

	var $support = function () {
		var canvas = document.createElement('canvas'),
			ctx = canvas.getContext('2d');

		return {
			canvas: !!ctx,
			imageData: !!ctx.getImageData,
			dataURL: !!canvas.toDataURL,
			btoa: !!window.btoa
		};
	}();

	var downloadMime = 'image/octet-stream';

	function scaleCanvas (canvas, width, height) {
		var w = canvas.width,
			h = canvas.height;
		if (width == undefined) {
			width = w;
		}
		if (height == undefined) {
			height = h;
		}

		var retCanvas = document.createElement('canvas');
		var retCtx = retCanvas.getContext('2d');
		retCanvas.width = width;
		retCanvas.height = height;
		retCtx.drawImage(canvas, 0, 0, w, h, 0, 0, width, height);
		return retCanvas;
	}

	function getDataURL (canvas, type, width, height) {
		canvas = scaleCanvas(canvas, width, height);
		return canvas.toDataURL(type);
	}

	function saveFile (strData) {
		document.location.href = strData;
	}

	function genImage(strData) {
		var img = document.createElement('img');
		img.src = strData;
		return img;
	}
	function fixType (type) {
		type = type.toLowerCase().replace(/jpg/i, 'jpeg');
		var r = type.match(/png|jpeg|bmp|gif/)[0];
		return 'image/' + r;
	}
	function encodeData (data) {
		if (!window.btoa) { throw 'btoa undefined' }
		var str = '';
		if (typeof data == 'string') {
			str = data;
		} else {
			for (var i = 0; i < data.length; i ++) {
				str += String.fromCharCode(data[i]);
			}
		}

		return btoa(str);
	}
	function getImageData (canvas) {
		var w = canvas.width,
			h = canvas.height;
		return canvas.getContext('2d').getImageData(0, 0, w, h);
	}
	function makeURI (strData, type) {
		return 'data:' + type + ';base64,' + strData;
	}

	var genBitmapImage = function (oData) {

		var biWidth  = oData.width;
		var biHeight	= oData.height;
		var biSizeImage = biWidth * biHeight * 3;
		var bfSize  = biSizeImage + 54;

		var BITMAPFILEHEADER = [
			0x42, 0x4D,
			bfSize & 0xff, bfSize >> 8 & 0xff, bfSize >> 16 & 0xff, bfSize >> 24 & 0xff,
			0, 0,
			0, 0,
			54, 0, 0, 0
		];

		var BITMAPINFOHEADER = [
			
			40, 0, 0, 0,
			biWidth & 0xff, biWidth >> 8 & 0xff, biWidth >> 16 & 0xff, biWidth >> 24 & 0xff,
			biHeight & 0xff, biHeight >> 8  & 0xff, biHeight >> 16 & 0xff, biHeight >> 24 & 0xff,
			1, 0,
			24, 0,
			0, 0, 0, 0,
			biSizeImage & 0xff, biSizeImage >> 8 & 0xff, biSizeImage >> 16 & 0xff, biSizeImage >> 24 & 0xff,
			0,0,0,0,
			0,0,0,0,
			0,0,0,0,
			0,0,0,0
		];

		var iPadding = (4 - ((biWidth * 3) % 4)) % 4;

		var aImgData = oData.data;

		var strPixelData = '';
		var biWidth4 = biWidth<<2;
		var y = biHeight;
		var fromCharCode = String.fromCharCode;

		do {
			var iOffsetY = biWidth4*(y-1);
			var strPixelRow = '';
			for (var x = 0; x < biWidth; x++) {
				var iOffsetX = x<<2;
				strPixelRow += fromCharCode(aImgData[iOffsetY+iOffsetX+2]) +
							   fromCharCode(aImgData[iOffsetY+iOffsetX+1]) +
							   fromCharCode(aImgData[iOffsetY+iOffsetX]);
			}

			for (var c = 0; c < iPadding; c++) {
				strPixelRow += String.fromCharCode(0);
			}

			strPixelData += strPixelRow;
		} while (--y);

		var strEncoded = encodeData(BITMAPFILEHEADER.concat(BITMAPINFOHEADER)) + encodeData(strPixelData);

		return strEncoded;
	};

	var saveAsImage = function (canvas, width, height, type) {
		if ($support.canvas && $support.dataURL) {
			if (typeof canvas == "string") { canvas = document.getElementById(canvas); }
			if (type == undefined) { type = 'png'; }
			type = fixType(type);
			if (/bmp/.test(type)) {
				var data = getImageData(scaleCanvas(canvas, width, height));
				var strData = genBitmapImage(data);
				saveFile(makeURI(strData, downloadMime));
			} else {
				var strData = getDataURL(canvas, type, width, height);
				saveFile(strData.replace(type, downloadMime));
			}
		}
	};

	var convertToImage = function (canvas, width, height, type) {
		if ($support.canvas && $support.dataURL) {
			if (typeof canvas == "string") { canvas = document.getElementById(canvas); }
			if (type == undefined) { type = 'png'; }
			type = fixType(type);

			if (/bmp/.test(type)) {
				var data = getImageData(scaleCanvas(canvas, width, height));
				var strData = genBitmapImage(data);
				return genImage(makeURI(strData, 'image/bmp'));
			} else {
				var strData = getDataURL(canvas, type, width, height);
				return genImage(strData);
			}
		}
	};



	return {
		saveAsImage: saveAsImage,
		saveAsPNG: function (canvas, width, height) {
			return saveAsImage(canvas, width, height, 'png');
		},
		saveAsJPEG: function (canvas, width, height) {
			return saveAsImage(canvas, width, height, 'jpeg');
		},
		saveAsGIF: function (canvas, width, height) {
			return saveAsImage(canvas, width, height, 'gif');
		},
		saveAsBMP: function (canvas, width, height) {
			return saveAsImage(canvas, width, height, 'bmp');
		},

		convertToImage: convertToImage,
		convertToPNG: function (canvas, width, height) {
			return convertToImage(canvas, width, height, 'png');
		},
		convertToJPEG: function (canvas, width, height) {
			return convertToImage(canvas, width, height, 'jpeg');
		},
		convertToGIF: function (canvas, width, height) {
			return convertToImage(canvas, width, height, 'gif');
		},
		convertToBMP: function (canvas, width, height) {
			return convertToImage(canvas, width, height, 'bmp');
		},
		scaleCanvas:scaleCanvas
	};

}();
</script>
<script type="text/javascript">



$(document).ready(function(){
 	var config = {
	    apiKey: "AIzaSyDb2nPveYGPXyw-SheNorRxM_93HhN5bhg",
	    authDomain: "wallte-2df83.firebaseapp.com",
	    databaseURL: "https://wallte-2df83.firebaseio.com",
	    projectId: "wallte-2df83",
	    storageBucket: "gs://wallte-2df83.appspot.com",
	    messagingSenderId: "629996778487"
 	};
  	firebase.initializeApp(config);
     
	function urltoFile(url, filename, mimeType){
	    return (fetch(url)
	        .then(function(res){return res.arrayBuffer();})
	        .then(function(buf){return new File([buf], filename, {type:mimeType});})
	    );
	}

	function getPreviewImage(canvas,largeUrl){
		var preview=Canvas2Image.scaleCanvas(canvas,240,240)
		
		var image=Canvas2Image.convertToJPEG(preview); 
        document.body.appendChild(image);
		
		var storageRef = firebase.storage().ref().child("1/img"+"-preview");
        imgText=$("img").attr('src')
            
            urltoFile(imgText, "hello"+"-preview"+".jpeg", 'image/jpeg')
				.then(function(file){
	    			storageRef.put(file).then(function(snapshot) {
	    				$("img").remove()

						$.ajax({
							url:"https://wallte.herokuapp.com/replyImage",
							type:"POST",
							data:{
								'token':$("#token").val(),
								'imageURL': largeUrl,
								'previewURL':snapshot.downloadURL
							}
						});

						$("body").append("<p id='success-mark'>Success</p>")
						
						window.open('','_parent',''); 
						window.close(); 
			});
		})

		
	}


	function getUrlVars()
	{
	    var vars = [], hash;
	    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
	    for(var i = 0; i < hashes.length; i++)
	    {
	        hash = hashes[i].split('=');
	        vars.push(hash[0]);
	        vars[hash[0]] = hash[1];
	    }
	    return vars;
	}

	
firebase.database().ref("/user/haha").set({
	json:"hahahah",
});


	html2canvas($("#image"), {
	        onrendered: function(canvas) {
	            theCanvas = canvas;
	            var image=Canvas2Image.convertToJPEG(canvas); 
	            document.body.appendChild(image);
	            var storageRef = firebase.storage().ref().child("1/img");
	            imgText=$("img").attr('src')
	            
	            urltoFile(imgText, 'hello.jpeg', 'image/jpeg')
					.then(function(file){
		    			storageRef.put(file).then(function(snapshot) {
		    					$("img").remove()
							  getPreviewImage(theCanvas,snapshot.downloadURL);
						});
					})
	                
	        }
    });




});
</script>

</html>